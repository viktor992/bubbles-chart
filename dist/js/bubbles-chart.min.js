/*!
  * bubbles-chart : Bubble chart
  * @version v0.0.3
  * @author Maximiliano Báez González <mxbg.py@gmail.com>
  */

d3.layout.orbit=function(){function _orbitLayout(){return _orbitLayout}function calculateNodes(){function traverseNestedData(_node){var target=childrenAccessor(_node);if(target){var thisPie=d3.layout.pie().value(function(d){return childrenAccessor(d)?4:1}),piedValues=thisPie(target);orbitalRings.push({source:_node,x:_node.x,y:_node.y,r:_node.ring/2});for(var x=0;x<target.length;x++)target[x].angle=(piedValues[x].endAngle-piedValues[x].startAngle)/2+piedValues[x].startAngle,target[x].parent=_node,target[x].depth=_node.depth+1,target[x].x=childrenAccessor(_node)[x].parent.x+target[x].parent.ring/2*Math.sin(target[x].angle),target[x].y=target[x].parent.y+target[x].parent.ring/2*Math.cos(target[x].angle),target[x].x0=target[x].parent.x,target[x].y0=target[x].parent.y,target[x].deltaX=function(_x){return _x},target[x].deltaY=function(_y){return _y},target[x].ring=childrenAccessor(_node)[x].parent.ring/orbitDepthAdjust(_node),flattenedNodes.push(target[x]),target[x].depth<=1}}var _data=nestedNodes;childrenAccessor(_data)?orbitNodes=_data:(orbitNodes={key:"root",values:_data},childrenAccessor(orbitNodes).forEach(function(_node){_node.parent=orbitNodes}));orbitNodes.x=orbitSize[0]/2,orbitNodes.y=orbitSize[1]/2,orbitNodes.deltaX=function(_x){return _x},orbitNodes.deltaY=function(_y){return _y},orbitNodes.ring=.75*orbitSize[0],orbitNodes.depth=0,flattenedNodes.push(orbitNodes),traverseNestedData(orbitNodes)}var orbitNodes,nestedNodes,orbitSize=[1,1],flattenedNodes=[],orbitDispatch=d3.dispatch("tick"),orbitalRings=[],orbitDepthAdjust=function(){return 2.95},childrenAccessor=function(d){return d.children};return _orbitLayout.mode=function(){},_orbitLayout.size=function(_value){return arguments.length?(orbitSize=_value,this):orbitSize},_orbitLayout.revolution=function(_function){return arguments.length?(tickRadianFunction=_function,this):tickRadianFunction},_orbitLayout.orbitSize=function(_function){return arguments.length?(orbitDepthAdjust=_function,this):orbitDepthAdjust},_orbitLayout.orbitalRings=function(){return arguments.length?this:orbitalRings},_orbitLayout.nodes=function(_data){return arguments.length?(nestedNodes=_data,calculateNodes(),this):flattenedNodes},_orbitLayout.children=function(_function){return arguments.length?(childrenAccessor=_function,this):childrenAccessor},d3.rebind(_orbitLayout,orbitDispatch,"on"),_orbitLayout};;
d3.selectable=function(ul,li,update){function isParentNode(parentNode,node){return!!node&&(node===parentNode||isParentNode(parentNode,node.parentNode))}function selectFirst(selection){selection.each(function(d,i){0===i&&(d._selected=!0)})}function selectLast(selection){selection.each(function(d,i,j){i===selection[j].length-1&&(d._selected=!0)})}function select(d,node){var parentNode=ul.filter(function(){return isParentNode(this,node)}).node(),lis=li.filter(function(){return isParentNode(parentNode,this)});if(d3.event.shiftKey){var firstSelectedIndex,lastSelectedIndex,currentIndex;lis.each(function(dl,i){dl._selected&&(firstSelectedIndex||(firstSelectedIndex=i),lastSelectedIndex=i),this===node&&(currentIndex=i)});var min=Math.min(firstSelectedIndex,lastSelectedIndex,currentIndex),max=Math.max(firstSelectedIndex,lastSelectedIndex,currentIndex);lis.each(function(d,i){d._selected=d3.event.ctrlKey&&d._selected||i>=min&&i<=max})}else d3.event.ctrlKey||lis.each(function(d){d._selected=!1}),d._selected=!d._selected;lastDecision=d._selected,update()}var lastDecision;ul.selectAll("li").on("mousedown",function(d){select(d,this)}).on("mouseover",function(d){d3.event.which&&(d._selected=lastDecision,update())});var keyCodes={up:38,down:40,home:36,end:35,a:65};ul.on("keydown",function(){if(d3.values(keyCodes).indexOf(d3.event.keyCode)!==-1&&(d3.event.keyCode!==keyCodes.a||d3.event.ctrlKey)){var focus=ul.filter(":focus").node();if(focus){d3.event.preventDefault();var scope=li.filter(function(d){return isParentNode(focus,this)}),selecteds=scope.select(function(d){return d._selected});d3.event.ctrlKey||scope.each(function(d){d._selected=!1});var madeSelection=!1;switch(d3.event.keyCode){case keyCodes.up:selecteds.each(function(d,i,j){scope[j][i-1]&&(madeSelection=d3.select(scope[j][i-1]).data()[0]._selected=!0)}),madeSelection||selectLast(scope);break;case keyCodes.down:selecteds.each(function(d,i,j){scope[j][i+1]&&(madeSelection=d3.select(scope[j][i+1]).data()[0]._selected=!0)}),madeSelection||selectFirst(scope);break;case keyCodes.home:selectFirst(scope);break;case keyCodes.end:selectLast(scope);break;case keyCodes.a:scope.each(function(d){d._selected=!d3.event.shiftKey})}update()}}})};;
function ConfigBuilder(){return{defaultColor:"#ddd",type:"none",width:500,height:500,sort:!1,percentage:!1,color:d3plus.color.scale,colour:!1,title:!1,leyend:!1,offset:5,padding:30,tooltip:!1,level:0,levels:[],filters:[],legend:!1,toggle:{title:"",size:!1},wave:{dy:11,count:4},tree:{speed:150,minRadius:10},animation:{speed:3e3,method:"no-recursive"},bubble:{minRadius:10,animation:2e3},cols:5,p:.3,timeContainer:"footer",listBubble:{minRadius:2,maxRadius:25,padding:5},format:{text:function(text,key){return d3plus.string.title(text)},number:function(number,data){return d3plus.number.format(number)}}}};
function BubbleEvents(){this.event={}}BubbleEvents.prototype.trigger=function(name,d){"undefined"!=typeof this.event[name]&&this.event[name](d)};;
function BaseBuilder(config){BubbleEvents.call(this,config),this.dataArray=[],this.timeArray=[],this.timeSelection=[],this.filters={},this.filtersData={},this.config=config,config&&(this.config.colour=0==this.config.colour?this.config.label:this.config.colour,this.config.title=0==this.config.title?function(d){return d[config.label]}:this.config.title)}BaseBuilder.prototype=new BubbleEvents,BaseBuilder.prototype.constructor=BaseBuilder,BaseBuilder.prototype.initialize=function(){},BaseBuilder.prototype.afterData=function(data){this.dataArray=$.extend([],data,!0)},BaseBuilder.prototype.data=function(data){this.afterData(data),this.builder(data),this.config.time&&this.timeline(),this.config.toggle.size&&this.sizeToggle(),this.config.levels.length>0&&this.breadcrumbs(),this.wrapText()},BaseBuilder.prototype.buildNodes=function(data,filter){var thiz=this;filter="undefined"==typeof filter||filter;for(var d=this.groupingData(data,filter),i=0;i<d.length;i++)d[i].value=d[i][thiz.config.size];var gdata={children:d};return gdata},BaseBuilder.prototype.roolupFilters=function(v,attr){var plainFilters=this.config.filters.map(function(e){return e.value});if(plainFilters.indexOf(attr)!=-1){this.filters[attr]="undefined"==typeof this.filters[attr]?[]:this.filters[attr],this.filtersData[attr]="undefined"==typeof this.filtersData[attr]?{}:this.filtersData[attr];var thiz=this;v.forEach(function(d){thiz.filters[attr].indexOf(d[attr])==-1&&(thiz.filters[attr].push(d[attr]),thiz.filtersData[attr][d[attr]]={size:0,r:0,cnt:0}),thiz.filtersData[attr][d[attr]].size+=d[thiz.config.size],thiz.filtersData[attr][d[attr]].cnt+=1})}},BaseBuilder.prototype.roolup=function(v,sample){var data={},thiz=this;for(var attr in sample)if(this.roolupFilters(v,attr),attr==this.config.time)data[attr]=v.map(function(d){return thiz.timeArray.indexOf(d[attr])==-1&&thiz.timeArray.push(d[attr]),d[attr]});else if(attr==this.config.label)data[attr]=v[0][attr];else if("number"==typeof sample[attr])data[attr]=d3.sum(v,function(d){return d[attr]});else if(attr==this.config.size)data[attr]=d3.sum(v,function(d){return"number"!=typeof d[attr]?parseFloat(d[attr]):d[attr]});else if("children"==attr){data[attr]=data[attr]?data[attr]:[];for(var i=0;i<v.length;i++)for(var j=0;j<v[i][attr].length;j++)data[attr].push(v[i][attr][j])}else data[attr]=v.map(function(d){return d[attr]});return data},BaseBuilder.prototype.groupingData=function(data,filter){var thiz=this,sampleObj=null,tmp=data.filter(function(d){var show=!0;if(!filter)return!0;if("undefined"==typeof d[thiz.config.time])return!0;if("number"==typeof d[thiz.config.time])show=thiz.timeSelection.indexOf(d[thiz.config.time])>=0;else for(var i=0;i<d[thiz.config.time].length;i++)show=show&&thiz.timeSelection.indexOf(d[thiz.config.time][i])>=0;return 0==thiz.timeSelection.length||show}),filters=d3.nest().key(function(d){return sampleObj=d,d[thiz.config.label]}).rollup(function(v){return thiz.roolup(v,sampleObj)}).entries(tmp);return filters.map(function(d){return d.values})};;
function UiBuilder(config){BaseBuilder.call(this,config)}UiBuilder.prototype=new BaseBuilder,UiBuilder.prototype.constructor=UiBuilder,UiBuilder.prototype.initialize=function(){this.prepareContainer()},UiBuilder.prototype.bindMouseEvents=function(node){var thiz=this;node.on("click",function(d){thiz.trigger("click",d)}).on("mouseenter",function(d){thiz.trigger("mouseenter",d)}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(this,d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")})},UiBuilder.prototype.prepareContainer=function(){this.diameter=$(this.config.container).height(),this.width=$(this.config.container).width()-this.config.padding,this.diameter=this.diameter<this.config.height?this.config.height:this.diameter,this.width=this.width<this.config.width?this.config.width:this.width,this.config.scope=this.config.container.replace("#",""),this.vizId=this.config.scope+"-viz",this.footerId=this.config.scope+"-footer",this.headerId=this.config.scope+"-header";var $header=$("<div />");$header.attr("id",this.headerId);var $viz=$("<div />");$viz.attr("id",this.vizId);var $footer=$("<div />");$footer.attr("id",this.footerId),$(this.config.container).addClass("bubble-chart"),$viz.addClass("bubble-viz"),$(this.config.container).append($header),$(this.config.container).append($viz),$(this.config.container).append($footer),$viz.height(this.diameter),$viz.width(this.diameter)},UiBuilder.prototype.text=function(node,options){function isLikeWhite(c){var dc=235,rgb=d3.rgb(c);return rgb.r>=dc&&rgb.g>=dc&&rgb.b>=dc}var type="undefined"!=typeof options&&"undefined"!=typeof options.type?options.type:"text",thiz=this;return node.append(type).attr("class","wrap").style("fill",function(d){var c=thiz.config.color(d[thiz.config.label]);return c=d3plus.color.text(c),isLikeWhite(c)?thiz.config.defaultColor:c}).text(function(d){return thiz.config.format.text(d[thiz.config.label])})},UiBuilder.prototype.circle=function(node,options){var thiz=this;return options="undefined"==typeof options?{}:options,options.offset="undefined"==typeof options.offset?0:options.offset,options.class="undefined"==typeof options.class?"shape":options.class,node.append("circle").attr("r",function(d){return d.r<options.offset?0:d.r-options.offset}).attr("class",options.class).style("fill",function(d){return"undefined"!=typeof options.fill?options.fill:thiz.config.color(d[thiz.config.label])})},UiBuilder.prototype.createTooltip=function(el,d){var thiz=this,data=[{value:d[thiz.config.size],name:thiz.config.size}];this.config.percentage&&data.push({value:100*this.config.percentage(d),name:"Percentage"}),data=this.config.tooltip?this.config.tooltip(d):data;for(var i=0;i<data.length;i++)data[i].name=thiz.config.format.text(data[i].name),isNaN(data[i].value)?data[i].value=thiz.config.format.text(data[i].value):data[i].value=thiz.config.format.number(data[i].value);var elP=$(el).position(),$el=($("#"+this.vizId).position(),d3.select(el)),bbox=$el.node().getBBox(),maxWidth=(d3.transform($el.attr("transform")).translate,300),maxHeigth=15+35*data.length,toffset=20,x=elP.left+bbox.width/2-maxWidth/2,y=elP.top-maxHeigth-toffset;x=x<0?0:x,y=x<0?0:y;var config={id:thiz.config.scope+"_visualization_focus",x:x,y:y,allColors:!0,fixed:!0,size:"small",color:thiz.config.color(d[thiz.config.label]),fontfamily:"Helvetica Neue",fontweight:200,fontsize:"15px",data:data,width:maxWidth,max_width:maxWidth,mouseevents:!1,arrow:!0,align:"bottom center",anchor:"top left",title:thiz.config.format.text(d[thiz.config.label])};d3plus.tooltip.create(config)},UiBuilder.prototype.wrapText=function(){$("#"+this.vizId).find(".wrap").each(function(){d3plus.textwrap().container(d3.select(this)).resize(!0).align("middle").valign("middle").draw()})},UiBuilder.prototype.breadcrumbs=function(){for(var $ul=$("<ul class='bubble-hierarchies'/>"),$liTmpl=$("<li / >"),$aTmpl=$("<a class='bubble-levels disable'/>"),i=0;i<this.config.levels.length;i++){var $li=$liTmpl.clone(),aId="bubble-li-lvl-"+i,$a=$aTmpl.clone();$a.attr("data-level",i),$a.attr("id",aId),$a.attr("data-name",this.config.levels[i]),$a.text(this.config.levels[i]),$li.append($a),$ul.append($li)}var $ol=$("<ol class='bubble-breadcrumbs' />");$(this.config.container).prepend($ol),$(this.config.container).prepend($ul)},UiBuilder.prototype.drillup=function(){for(var level=this.config.level,$labels=$(this.config.container).find(".bubble-breadcrumbs"),$brumbs=$(this.config.container).find(".bubble-hierarchies"),len=$brumbs.find("[data-level]").length,i=level;i<len;i++){$labels.find("[data-level='"+i+"']").remove();var $aEl=$brumbs.find("[data-level='"+i+"']"),aId=$aEl.attr("id");$aEl.addClass("disable"),$("."+aId).remove()}},UiBuilder.prototype.updateBreadcrumbs=function(d){var fill=this.config.color(d[this.config.label]),textColor=d3plus.color.text(fill),$brumbs=$(this.config.container).find(".bubble-hierarchies"),$a=$brumbs.find("[data-level='"+this.config.level+"']"),aId=$a.attr("id");$a.removeClass("disable");var aStyle="<style class='{id}'>";aStyle+="a#{id}::before {border-color: {fill} {fill} {fill} transparent;}",aStyle+="li:last-child a#{id}::after {border-color: {fill} {fill} {fill} {fill};}",aStyle+="li a#{id}::after {border-left: 1em solid {fill};}",aStyle+="a#{id}{background-color: {fill}; color:{text}}",aStyle+="li:first-child a#{id}::before{border-color: {fill} {fill} {fill} {fill};}",aStyle+="</style>",aStyle=aStyle.replace(/{id}/g,aId).replace(/{fill}/g,fill).replace(/{text}/g,textColor),$a.append($(aStyle));var $labels=$(this.config.container).find(".bubble-breadcrumbs"),$li=$("<li/ >");$li.attr("data-level",this.config.level);var $span=$("<span class='text'/>"),$div=$("<div class='note'/>");$span.text(this.config.format.text(d[this.config.label])),$div.text(this.config.format.number(d[this.config.size])),$li.append($span),$labels.append($li)},UiBuilder.prototype.onChange=function(){var data=$.extend([],this.dataArray,!0);this.builder(data),this.wrapText()},UiBuilder.prototype.timeline=function(){var timeId="header"==this.config.timeContainer?this.headerId:this.footerId;timeId="#"+timeId,$(timeId).html("");var ul=d3.select(timeId).append("ul").attr("class","timeline").attr("tabindex",1),thiz=this,time=this.timeArray.sort().map(function(d){var data={time:d};return(0==thiz.timeSelection.length||thiz.timeSelection.indexOf(d)>=0)&&(data._selected=!0),data}),li=ul.selectAll("li").data(time).enter().append("li").attr("class","entry").classed("selected",function(d){return d._selected}).append("a").text(function(d){return d.time});this.selectable(ul,li,function(e){var selections=[];ul.selectAll("li").classed("selected",function(d){return d._selected&&selections.push(d),d._selected}),thiz.timeSelection=selections.map(function(d){return d.time}),thiz.onChange(),thiz.trigger("timechange",thiz.timeSelection)})},UiBuilder.prototype.selectable=function(ul,li,update){function isParentNode(parentNode,node){return!!node&&(node===parentNode||isParentNode(parentNode,node.parentNode))}function selectFirst(selection){selection.each(function(d,i){0===i&&(d._selected=!0)})}function selectLast(selection){selection.each(function(d,i,j){i===selection[j].length-1&&(d._selected=!0)})}function select(d,node){var parentNode=ul.filter(function(){return isParentNode(this,node)}).node(),lis=li.filter(function(){return isParentNode(parentNode,this)});if(d3.event.shiftKey){var firstSelectedIndex,lastSelectedIndex,currentIndex;lis.each(function(dl,i){dl._selected&&(firstSelectedIndex||(firstSelectedIndex=i),lastSelectedIndex=i),this===node&&(currentIndex=i)});var min=Math.min(firstSelectedIndex,lastSelectedIndex,currentIndex),max=Math.max(firstSelectedIndex,lastSelectedIndex,currentIndex);lis.each(function(d,i){d._selected=d3.event.ctrlKey&&d._selected||i>=min&&i<=max})}else d3.event.ctrlKey||lis.each(function(d){d._selected=!1}),d._selected=!d._selected;lastDecision=d._selected,update()}var lastDecision;ul.selectAll("li").on("mousedown",function(d){select(d,this)}).on("mouseover",function(d){d3.event.which&&(d._selected=lastDecision,update())});var keyCodes={up:38,down:40,home:36,end:35,a:65};ul.on("keydown",function(){if(d3.values(keyCodes).indexOf(d3.event.keyCode)!==-1&&(d3.event.keyCode!==keyCodes.a||d3.event.ctrlKey)){var focus=ul.filter(":focus").node();if(focus){d3.event.preventDefault();var scope=li.filter(function(d){return isParentNode(focus,this)}),selecteds=scope.select(function(d){return d._selected});d3.event.ctrlKey||scope.each(function(d){d._selected=!1});var madeSelection=!1;switch(d3.event.keyCode){case keyCodes.up:selecteds.each(function(d,i,j){scope[j][i-1]&&(madeSelection=d3.select(scope[j][i-1]).data()[0]._selected=!0)}),madeSelection||selectLast(scope);break;case keyCodes.down:selecteds.each(function(d,i,j){scope[j][i+1]&&(madeSelection=d3.select(scope[j][i+1]).data()[0]._selected=!0)}),madeSelection||selectFirst(scope);break;case keyCodes.home:selectFirst(scope);break;case keyCodes.end:selectLast(scope);break;case keyCodes.a:scope.each(function(d){d._selected=!d3.event.shiftKey})}update()}}})};;
function BubbleAnimation(config){this.config=config,this.initialize()}BubbleAnimation.prototype.animationTick=function(method,validate,speed){var thiz=this;speed=speed?speed:this.config.animation.speed;var interval=setInterval(function(){var waves=$(".wave");validate(waves.length)?thiz[method]():clearInterval(interval)},speed)},BubbleAnimation.prototype.initialize=function(){return"recursive"==this.config.method?void this.animate():void this.animationTick("animate",function(l){return l>0},10)},BubbleAnimation.prototype.animateWave=function(wave){var thiz=this;wave.attr("transform",function(d){return"translate("+d.r+")"}),wave.transition().duration(this.config.speed).ease("linear").attr("transform",function(d){return"translate( -"+d.r+")"}).attr("T",1).each("end",function(){wave.attr("T",0),"recursive"==thiz.config.method&&thiz.animateWave(wave)})},BubbleAnimation.prototype.animate=function(){var thiz=this;d3.selectAll("path").filter(function(d){var wave=d3.select(this);return 0==wave.attr("T")}).each(function(d,i){var wave=d3.select(this);wave.attr("T")>0||thiz.animateWave(wave)})};;
function BubbleBuilder(config){UiBuilder.call(this,config),config&&this.initialize()}BubbleBuilder.prototype=new UiBuilder,BubbleBuilder.prototype.constructor=BubbleBuilder,BubbleBuilder.prototype.builder=function(data){var thiz=this,bubble=d3.layout.pack().size([this.diameter,this.diameter]).padding(1.5);this.config.sort&&bubble.sort(function(a,b){return a.value-b.value});var vizId="#"+this.vizId;$(vizId).html("");var svg=d3.select(vizId).append("svg").attr("width",this.width).attr("height",this.diameter).attr("class","bubble"),node=svg.selectAll(".node").data(bubble.nodes(this.buildNodes(data)).filter(function(d){return!d.children})).enter().append("g").attr("class","node").attr("transform",function(d){return"translate("+d.x+","+d.y+")"});this.bindMouseEvents(node);var gnode=node.append("g");this.circle(gnode).style("stroke",function(d){var c=thiz.config.color(d[thiz.config.colour]);return d3plus.color.legible(c)});this.config.percentage?(this.circle(gnode,{offset:thiz.config.offset}).style("stroke","#FFF").style("stroke-width","2px"),this.buildGauge(node)):(this.circle(gnode),this.text(gnode)),"liquid"==this.config.type&&(this.animation=new BubbleAnimation(this.config.animation))},BubbleBuilder.prototype.fillPercentage=function(d){if(2*d.r<this.config.offset)return 0;var p=this.config.percentage(d);return p=2*d.r*(1-p),p<0?0:parseInt(p)},BubbleBuilder.prototype.buildWave=function(clip){var thiz=this;clip.append("path").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("class","path wave").attr("T",0).attr("d",function(d){var p=thiz.fillPercentage(d);if(0==p)return"";for(var x=parseInt(2*-d.r),dx=parseInt(4*d.r/thiz.config.wave.count),b="",y0=p-d.r;x<2*d.r;)b+=" M "+x+" "+y0+" q "+dx/2+" "+thiz.config.wave.dy+" "+dx+" 0",x+=dx;return b+""})},BubbleBuilder.prototype.buildGauge=function(node){var g=node.append("g"),thiz=this,clip=g.append("clipPath").attr("id",function(d){return"g-clip-"+d3plus.string.strip(d[thiz.config.label])});clip.append("rect").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("y",function(d){return-d.r+thiz.config.offset}).attr("x",function(d){return-d.r+thiz.config.offset}).attr("width",function(d){return 2*d.r<thiz.config.offset?0:2*d.r-thiz.config.offset}).attr("height",function(d){var p=thiz.fillPercentage(d);return p+=thiz.config.offset-thiz.config.wave.dy+1,p<0?0:p}),"liquid"!=this.config.type&&"wave"!=this.config.type||this.buildWave(clip),this.circle(g,{offset:thiz.config.offset,fill:"#FFF"}).attr("clip-path",function(d){var clip=window.location.href;return clip=clip.split("#")[0],clip+="#g-clip-"+d3plus.string.strip(d[thiz.config.label]),"url("+clip+")"}),this.text(g)},BubbleBuilder.prototype.sizeToggle=function(){var $footer=$("#"+this.footerId),$toogle=$("<div></div>");$toogle.addClass("bubble-toogle"),$toogle.attr("id",this.footerId+"-toogle"),$footer.append($toogle);var thiz=this;d3plus.form().data(this.config.toggle.size).title(this.config.toggle.title).container("#"+this.footerId+"-toogle").id("value").text("text").type("toggle").draw();$footer.find(".d3plus_toggle").on("click",function(d){var $target=$(this)[0],data=$target.__data__;"undefined"!=typeof data&&(thiz.config.size=data.value,thiz.onChange())})};;
function TreeBuilder(config){UiBuilder.call(this,config),this.rscale=0,this.center={node:[],ring:[],idx:0},config&&this.initialize()}TreeBuilder.prototype=new UiBuilder,TreeBuilder.prototype.constructor=TreeBuilder,TreeBuilder.prototype.prepareData=function(data){var thiz=this,childs=this.buildNodes(data.children);data.children=childs.children,data[thiz.config.size]=d3.sum(data.children,function(d){return d[thiz.config.size]}),data.max=d3.max(data.children,function(d){return d[thiz.config.size]}),data.min=d3.min(data.children,function(d){return d[thiz.config.size]}),data.min=data.min==data.max?0:data.min;var nChilds=5+data.children.length;return nChilds=nChilds<10?10:nChilds,this.rscale=d3.scale.linear().domain([data.min,data.max]).range([0,this.diameter/nChilds]),data},TreeBuilder.prototype.circle=function(node){function r(d,offset){if(!(d.depth>1)){offset=offset?offset:0;var r=thiz.rscale(d[thiz.config.size])-offset;return d.max&&(r=thiz.diameter/6-offset),d.r=r,r<thiz.config.tree.minRadius?thiz.config.tree.minRadius:r}}var thiz=this;node.append("circle").attr("class","shape").attr("r",r).style("fill",function(d){return thiz.config.color(d[thiz.config.colour])}).style("stroke",function(d){var c=thiz.config.color(d[thiz.config.colour]);return d3plus.color.legible(c)}),this.text(node);node.append("circle").attr("class","shape-border").filter(function(d){return!d.parent}).attr("r",function(d){return r(d,5)}).style("fill","transparent").style("stroke","white").style("stroke-dasharray","5,5").style("stroke-width","1px")},TreeBuilder.prototype.onChange=function(){var data=$.extend({},this.dataArray[this.config.level],!0);this.builder(data),this.wrapText()},TreeBuilder.prototype.redraw=function(data,storeVal){var lvl=this.config.level;storeVal?this.dataArray[lvl]=$.extend({},data,!0):data=$.extend({},this.dataArray[lvl],!0),this.builder(data),this.config.time&&this.timeline(),this.wrapText()},TreeBuilder.prototype.afterData=function(data){this.dataArray[this.config.level]=$.extend({},data,!0)},TreeBuilder.prototype.builder=function(data){var vizId="#"+this.vizId,thiz=this,viz=document.getElementById(this.vizId);viz.innerHTML="",orbitScale=d3.scale.linear().domain([1,3]).range([3.8,1.5]).clamp(!0);var orbit=d3.layout.orbit().size([this.diameter,this.diameter]).children(function(d){return d.children}).revolution(function(d){return d.depth}).orbitSize(function(d){return orbitScale(d.depth)}),gdata=this.prepareData(data);orbit.nodes(gdata);var container=$(vizId).find("svg");container=0==container.length?d3.select(vizId).append("svg"):d3.select(vizId).select("svg");var nodes=container.selectAll("g.node").data(orbit.nodes()).enter().append("g").attr("class",function(d){var clazz="node";return d.parent||(clazz+=" center"),clazz}).attr("transform",function(d){return d.parent?"translate("+d.x0+","+d.y0+")":"translate("+d.x+","+d.y+")"}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(this,d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")}).on("click",function(d){thiz.onClick(d3.select(this),d)});nodes.transition().duration(this.config.tree.speed).ease("linear").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("T",1).each("end",function(){nodes.attr("T",0)}),this.circle(d3.selectAll("g.node")),d3.select("svg").selectAll("circle.orbits").data(orbit.orbitalRings()).enter().insert("circle","g").attr("class","ring").attr("r",function(d){return d.r}).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).style("fill","none").style("stroke","black").style("stroke-dasharray","2,2").style("stroke-width","1px")},TreeBuilder.prototype.getCleandata=function(d,step){var tmp={};tmp[this.config.label]=d[this.config.label],tmp[this.config.size]=d[this.config.size],this.config.time&&d[this.config.time]&&(tmp[this.config.time]=d[this.config.time]),d.children&&(tmp.children=$.extend([],d.children,!0));var lvl=this.config.level;return lvl>=0&&(tmp._parent=$.extend({},this.dataArray[lvl],!0)),tmp},TreeBuilder.prototype.getChild=function(d){var dArray=$.extend({},this.dataArray[this.config.level],!0),tmp=this.buildNodes(dArray.children,!1);dArray.children=tmp.children;for(var i=0;i<dArray.children.length;i++)if(dArray.children[i][this.config.label]==d[this.config.label])return dArray.children[i];console.error("no child")},TreeBuilder.prototype.onClick=function(node,d){if(d.children&&(d.parent||d._parent)){var $center=d3.select(".node.center"),cr=$center.select("circle.shape").attr("r"),cxy=$center.attr("transform");this.animateRingNode(node,d,{cr:cr,cxy:cxy})}},TreeBuilder.prototype.ringDrillup=function(d){this.config.level-=1;var tmp=this.getCleandata(d._parent);this.redraw(tmp),this.config.levels.length>0&&this.drillup(d)},TreeBuilder.prototype.ringDrilldown=function(d){var tmp=this.getCleandata(this.getChild(d));this.config.levels.length>0&&this.config.levels.length>this.config.level+1&&(this.updateBreadcrumbs(d),this.config.level+=1),this.redraw(tmp,!0)},TreeBuilder.prototype.transition=function(node,transform,end){return node.transition().duration(this.config.tree.speed).ease("linear").attr("transform",transform).attr("T",1).each("end",function(d){d3.select(this).attr("T",0),end&&end(this,d)})},TreeBuilder.prototype.animateRingNode=function(node,pd,options){var thiz=this;this.transition(node,options.cxy),node.select(".shape").transition().duration(this.config.tree.speed).ease("linear").attr("r",options.cr).attr("T",1).each("end",function(d){node.select(".shape").attr("T",0),d.children&&(d.max?d._parent&&thiz.ringDrillup(d):thiz.ringDrilldown(d))})};;
function OrbitBuilder(config){TreeBuilder.call(this,config),this.rscale=0,this.center={node:[],ring:[],idx:0}}function d3Clone(node){return node.node().cloneNode(!0)}OrbitBuilder.prototype=new TreeBuilder,OrbitBuilder.prototype.constructor=OrbitBuilder,OrbitBuilder.prototype.builder=function(data){var vizId="#"+this.vizId,thiz=this,viz=document.getElementById(this.vizId);viz.innerHTML="",orbitScale=d3.scale.linear().domain([1,3]).range([3.8,1.5]).clamp(!0);var orbit=d3.layout.orbit().size([this.diameter,this.diameter]).children(function(d){return d.children}).revolution(function(d){return d.depth}).orbitSize(function(d){return orbitScale(d.depth)}),gdata=this.prepareData(data);orbit.nodes(gdata);var container=$(vizId).find("svg");container=0==container.length?d3.select(vizId).append("svg"):d3.select(vizId).select("svg"),this.center.node.length>0&&(container.node().appendChild(this.center.node[this.center.idx-1]),container.node().appendChild(this.center.ring[this.center.idx-1]));var nodes=container.selectAll("g.node").data(orbit.nodes()).enter().append("g").attr("class",function(d){var clazz="node";return d.parent||(clazz+=" center"),clazz}).attr("transform",function(d){return d.parent?"translate("+d.x0+","+d.y0+")":"translate("+d.x+","+d.y+")"}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(this,d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")}).on("click",function(d){thiz.onClick(d3.select(this),d)});nodes.transition().duration(this.config.tree.speed).ease("linear").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("T",1).each("end",function(){nodes.attr("T",0)}),this.circle(d3.selectAll("g.node")),d3.select("svg").selectAll("circle.orbits").data(orbit.orbitalRings()).enter().insert("circle","g").attr("class","ring").attr("r",function(d){return d.r}).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).style("fill","none").style("stroke","black").style("stroke-dasharray","2,2").style("stroke-width","1px")},OrbitBuilder.prototype.onClick=function(node,d){if(d.children&&(d.parent||d._parent)){var $center=d3.select(".node.center"),cr=$center.select("circle.shape").attr("r"),cxy=$center.attr("transform");this.animateCenterNode($center,d),this.animateRingNode(node,d,{cr:cr,cxy:cxy})}},OrbitBuilder.prototype.text=function(node,options){function isLikeWhite(c){var dc=235,rgb=d3.rgb(c);return rgb.r>=dc&&rgb.g>=dc&&rgb.b>=dc}var type="undefined"!=typeof options&&"undefined"!=typeof options.type?options.type:"text",thiz=this;return node.append(type).attr("class","wrap").style("fill",function(d){var c=thiz.config.color(d[thiz.config.colour]);return c=d3plus.color.text(c),isLikeWhite(c)?thiz.config.defaultColor:c}).text(function(d){return thiz.config.format.number(d[thiz.config.size])})},OrbitBuilder.prototype.orbitRotate=function(node,pd,options){function angle(d){var yi=pd.y-(y-r),xi=pd.x-(x-r),yc=r,xc=r,dx=xi-xc,dy=yc-yi,a=Math.atan2(dy,dx)*(180/Math.PI);return a<0?a-180:a}var ring=d3.select(".ring"),x=parseFloat(ring.attr("cx")),y=parseFloat(ring.attr("cy")),r=parseFloat(ring.attr("r"));node.attr("transform",options.cxy);var shape=node.select(".shape").attr("cx",function(d){return d.x-x}).attr("cy",function(d){return d.y-y}),thiz=this,speed=this.config.tree.speed/2;shape.transition().duration(speed).ease("cubic").delay(function(d,i){return 120*i}).attrTween("transform",function(d,i){var ai=angle(d),i=d3.interpolate(0,ai);return function(t){return"rotate("+i(t)+")"}}).each("end",function(){var ctr=node.attr("transform");ctr=ctr.split(";"),node.select(".shape").transition().duration(speed).ease("linear").attr("cy",function(d){var cr=d.r<thiz.config.tree.minRadius?thiz.config.tree.minRadius:d.r;return y-r-cr-3*thiz.config.offset}).attr("T",1).each("end",function(){d3.select(this).attr("T",0),options.end(node,speed)})})},OrbitBuilder.prototype.animateRingNode=function(node,pd,options){function reshape(node,speed){speed=speed?speed:thiz.config.tree.speed,node.select(".shape").transition().duration(speed).ease("linear").attr("r",options.cr).attr("T",1).each("end",function(d){node.select(".shape").attr("T",0),d.children&&(d.max?d._parent&&thiz.ringDrillup(d):thiz.ringDrilldown(d))})}var thiz=this;pd.max?(options.cr=this.config.tree.minRadius,this.transition(node,function(d){return"translate ( "+2*d.x+","+d.y+")"},function(){reshape(node)})):(options.end=function(node,speed){reshape(node,speed)},this.orbitRotate(node,pd,options))},OrbitBuilder.prototype.animateCenterNode=function($center,pd){var thiz=this;if(pd.max){var tmp=thiz.center.node.pop();if(thiz.center.ring.pop(),thiz.center.idx-=1,thiz.center.idx<=0)return void(thiz.center.idx=0);this.transition(d3.select(tmp),function(d){return"translate("+pd.x+","+pd.y+")"},function(){tmp.remove()})}else this.transition($center,function(d){return"translate("+-d.r/2+","+d.y+")"},function(el,d){$center.attr("class","parent");var vizId="#"+thiz.vizId,$ring=d3.select(vizId).selectAll(".ring").attr("cx",0).attr("r",function(d){return 1.4*d.r}).attr("cy",function(d){return d.y});$ring.attr("class","parent-ring"),thiz.center.node.push(d3Clone($center)),thiz.center.ring.push(d3Clone($ring)),thiz.center.idx+=1})};;
function ListBuilder(config){if(UiBuilder.call(this,config),this.rscale=0,this.activeFilters={},config){var tmp=this.config.xAxis;"string"==typeof this.config.xAxis&&(this.config.xAxis={},this.config.xAxis.key=tmp),this.initialize()}}ListBuilder.prototype=new UiBuilder,ListBuilder.prototype.constructor=ListBuilder,ListBuilder.prototype.prepareContainer=function(){UiBuilder.prototype.prepareContainer.call(this),$("#"+this.vizId).width(this.width)},ListBuilder.prototype.data=function(data){this.afterData(data),this.pData=this.prepareData(data),this.config.filters.length>0&&this.buildFilter(),this.builder(this.pData),this.config.time&&this.timeline()},ListBuilder.prototype.buildFilter=function(){var thiz=this,filters=[];this.config.filters.length>0&&(filters=filters.concat(this.config.filters));for(var container=this.headerId,i=0;i<filters.length;i++){var filter=filters[i].value,$footer=$("#"+container),$toogle=$("<div></div>"),toggleId=container+"-"+filter;$toogle.addClass("bubble-toogle"),$toogle.attr("id",toggleId),$footer.append($toogle);var selected=!0,dataFilters=this.filters[filter].map(function(d){var dmap={text:d,value:d,attr:filter};return selected&&(dmap.selected=!1,selected=!1,thiz.activeFilters[filter]=d),dmap}),thiz=this;d3plus.form().data(dataFilters).container("#"+toggleId).title(filters[i].text).id("value").text("text").type("toggle").draw()}$footer.find(".d3plus_toggle").on("click",function(d){var $target=$(this)[0],data=$target.__data__;"undefined"!=typeof data&&(thiz.activeFilters[data.attr]=data.value,console.log(thiz.activeFilters),thiz.builder(thiz.pData))})},ListBuilder.prototype.roolup=function(v,sample){for(var attr in sample)this.roolupFilters(v,attr);return v},ListBuilder.prototype.prepareData=function(data){var thiz=this;this.groups=[];var sampleObj,tmp=d3.nest().key(function(d){return sampleObj=d,thiz.groups.indexOf(d[thiz.config.xAxis.key])<0&&thiz.groups.push(d[thiz.config.xAxis.key]),d[thiz.config.label]}).rollup(function(d){return thiz.roolup(d,sampleObj)}).entries(data);return tmp.max=d3.max(thiz.groups,function(d){return d}),tmp.min=d3.min(thiz.groups,function(d){return d}),tmp.map(function(d){return d[thiz.config.label]=d.key,d[thiz.config.size]=d3.sum(d.values,function(d){return d[thiz.config.size]}),d}),this.prepareScale(tmp),tmp},ListBuilder.prototype.prepareScale=function(data){var len=this.groups.length;this.w=this.rowSize()*len,this.x=d3.scale.linear().range([this.rowSize(),this.w]),this.xAxis=d3.svg.axis().scale(this.x).orient("top"),"undefined"!=typeof this.config.xAxis.format&&this.xAxis.tickFormat(this.config.xAxis.format),this.x.domain([data.min,data.max]),this.xScale=d3.scale.linear().domain([data.min,data.max]).range([this.rowSize(),this.w])},ListBuilder.prototype.bindEvents=function(node){var thiz=this;node.on("click",function(d){thiz.trigger("click",d)}).on("mouseenter",function(d){thiz.trigger("mouseenter",d)}).on("mouseover",function(d){if(thiz.trigger("mouseover",d),thiz.createTooltip(this,d),"text"==this.nodeName){var g=d3.select(this).node().parentNode;d3.select(g).selectAll("circle").style("display","none"),d3.select(g).selectAll("text.value").style("display","block")}}).on("mouseout",function(d){if(thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus"),"text"==this.nodeName){var g=d3.select(this).node().parentNode;d3.select(g).selectAll("circle").style("display","block"),d3.select(g).selectAll("text.value").style("display","none")}})},ListBuilder.prototype.circle=function(g,data){var thiz=this,rscale=this.scale(data),circles=g.selectAll("g").data(data.values).enter().append("circle").attr("cx",function(d,i){return thiz.xScale(d[thiz.config.xAxis.key])}).attr("cy",data.y).attr("r",function(d){return rscale(d[thiz.config.size])}).attr("fill",thiz.config.color(data[this.config.colour]));return this.bindEvents(circles),circles},ListBuilder.prototype.text=function(g,data){var thiz=this;return g.selectAll("g").data(data.values).enter().append("text").attr("y",data.y).attr("x",function(d){return thiz.xScale(d[thiz.config.xAxis.key])}).attr("class","value").text(function(d){return d[thiz.config.size]}).attr("fill",this.config.color(data[this.config.colour])).style("display","none")},ListBuilder.prototype.rowSize=function(){return 2*(this.config.listBubble.maxRadius+this.config.listBubble.padding)},ListBuilder.prototype.scale=function(data){var thiz=this;return d3.scale.linear().domain([0,d3.max(data.values,function(d){return d[thiz.config.size]})]).range([this.config.listBubble.minRadius,this.config.listBubble.maxRadius])},ListBuilder.prototype.filtrar=function(data){for(var thiz=this,result=[],i=0;i<data.length;i++){for(var tmp=[],j=0;j<data[i].values.length;j++){var d=data[i].values[j],show=!0;for(filter in thiz.activeFilters)show=show&&d[filter]==thiz.activeFilters[filter];show&&tmp.push(d)}if(tmp.length>0){var d=$.extend({},data[i],!0);d.values=tmp;for(filter in thiz.activeFilters)d[filter]=thiz.activeFilters[filter];result.push(d)}}return result},ListBuilder.prototype.builder=function(data){function getY(d){return index+=1,d.y=index*thiz.rowSize(),d.y}var index=0,thiz=this,fData=$.extend([],data,!0);fData=this.filtrar(fData),d3.select("#"+this.vizId).selectAll("svg").remove();var svg=d3.select("#"+this.vizId).append("svg").style("width",this.width).attr("height",this.diameter),px=this.rowSize(),node=svg.append("g").attr("transform","translate(0,"+thiz.config.listBubble.maxRadius+")");node.append("g").attr("class","x axis").call(this.xAxis);var g=svg.selectAll(".node").data(fData).enter().append("g").attr("y",getY).attr("class","node"),text=g.append("text").attr("x",this.w+px).attr("y",function(d){return d.y}).attr("class","label").text(function(d){return thiz.circle(d3.select(this.parentNode),d),thiz.text(d3.select(this.parentNode),d),d[thiz.config.label]}).style("fill",function(d){return thiz.config.color(d[thiz.config.colour])});this.bindEvents(text);var h=this.rowSize()*fData.length+3*thiz.config.padding;$("#"+this.vizId).height(h),svg.attr("height",h)};;
function MotionBubble(config){UiBuilder.call(this,config),this.rscale=0,this.damper=.15,this.layoutGravity=-.01,config&&this.initialize()}MotionBubble.prototype=new UiBuilder,MotionBubble.prototype.constructor=MotionBubble,MotionBubble.prototype.prepareContainer=function(){UiBuilder.prototype.prepareContainer.call(this);var $viz=$("#"+this.vizId);$viz.width(this.width),this.center={x:this.width/2,y:this.diameter/2}},MotionBubble.prototype.buildFilter=function(){var filters=[];this.config.filters.length>0&&(filters.push({text:"Todos",value:"all"}),filters=filters.concat(this.config.filters));var container=this.headerId,$footer=$("#"+container),$toogle=$("<div></div>");$toogle.addClass("bubble-toogle"),$toogle.attr("id",container+"-toogle"),$footer.append($toogle);var thiz=this;d3plus.form().data(filters).container("#"+container+"-toogle").id("value").text("text").type("toggle").draw();$footer.find(".d3plus_toggle").on("click",function(d){var $target=$(this)[0],data=$target.__data__;"undefined"!=typeof data&&("all"!==data.value?($("#"+thiz.legendId).hide(),$("#"+thiz.legendRightId).hide(),thiz.groupAll(thiz.circles,data.value)):($("#"+thiz.legendId).show(),$("#"+thiz.legendRightId).show(),thiz.groupAll(thiz.circles)))})},MotionBubble.prototype.getMaxRadius=function(attr){var max=null;for(var key in this.filtersData[attr]){var d=this.filtersData[attr][key];"string"!=typeof d&&(max=null==max||max<d.r?d.r:max)}return max},MotionBubble.prototype.calculateFilterCenter=function(){this.filterCenters={};var cols=($("#"+this.vizId),this.config.cols),xpadding=80,ypadding=100,txtHeight=40;for(var attr in this.filters){this.filterCenters[attr]={};var len=this.filters[attr].length;cols=this.config.cols,cols=len<cols?len:cols;var nrows=parseInt(len/cols);nrows=1==nrows?2:nrows;for(var dx=(this.width-2*xpadding)/cols,dy=(this.diameter-ypadding)/nrows,idx=1,y0=ypadding/2,maxR=0,prevX=0,i=0;i<len;i++){var strTmp=this.filters[attr][i],fdata=this.filtersData[attr][strTmp];fdata.r=Math.sqrt(fdata.r),idx>cols&&(idx=1,y0+=dy+maxR+txtHeight,maxR=0),maxR=maxR<fdata.r?fdata.r:maxR;var y=(parseInt(i/cols),y0+dy);y+=txtHeight;var x=0;x=1===idx?xpadding+dx/2:prevX+dx,prevX=x,this.filterCenters[attr][strTmp]={x:x,y:y,r:fdata.r,size:fdata.size,filter:strTmp},idx+=1}this.filtersData[attr].MAX_Y=y+dy+maxR+ypadding}this.resizeViz(this.diameter+ypadding)},MotionBubble.prototype.roolup=function(v,sample){var data={},thiz=this;for(var attr in sample){this.roolupFilters(v,attr);for(var i=0;i<v.length;i++)attr==this.config.time?data[attr]=v.map(function(d){return thiz.timeArray.indexOf(d[attr])==-1&&thiz.timeArray.push(d[attr]),d[attr]}):attr==this.config.size?data[attr]=d3.sum(v,function(d){return d[attr]}):data[attr]=v[0][attr]}return data},MotionBubble.prototype.buildNodes=function(data,filter){var thiz=this;UiBuilder.prototype.buildNodes.call(this,data,filter);var darray=data,max=d3.max(darray,function(d){return d[thiz.config.size]}),min=d3.min(darray,function(d){return d[thiz.config.size]});this.sizeData={},this.sizeData.max=max,this.sizeData.min=min,min=min==max?0:min;var nChilds=darray.length-10;nChilds=nChilds<5?5:nChilds,nChilds=nChilds>30?30:nChilds;var maxR=this.width/nChilds;return this.rscale=d3.scale.pow().exponent(.5).domain([min,max]).range([this.config.bubble.minRadius,maxR]),darray.forEach(function(d){d.x=Math.random()*thiz.width,d.y=Math.random()*thiz.diameter,d.value=d[thiz.config.size],d.r=thiz.rscale(d.value);for(var attr in thiz.filters)thiz.filtersData[attr][d[attr]].r+=d.r*d.r}),darray=darray.sort(function(a,b){return b[thiz.config.size]-a[thiz.config.size]}),this.calculateFilterCenter(),darray},MotionBubble.prototype.builder=function(data){d3.select("#"+this.vizId).html("");var svg=d3.select("#"+this.vizId).append("svg").attr("width",this.width).attr("height",this.diameter);this.buildFilter();var thiz=this;this.nodes=this.buildNodes(data),this.circles=svg.selectAll("circle").data(this.nodes).enter().append("circle").attr("class","node").attr("r",0).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("fill",function(d){return console.log("builder"),console.log(d),console.log(d[thiz.config.colour]),console.log(thiz.config.color(d[thiz.config.colour])),thiz.config.color(d[thiz.config.colour])}).attr("stroke-width",1).attr("stroke",function(d){var c=thiz.config.color(d[thiz.config.colour]),b=d3plus.color.legible(c);return c.toUpperCase()==b.toUpperCase()&&(b=d3plus.color.lighter(c,-.3)),b}),this.bindMouseEvents(this.circles),this.circles.transition().duration(this.config.bubble.animation).attr("r",function(d){return d.r}),this.start(),this.groupAll(this.circles),this.config.legend&&(this.legend(),this.legendRight())},MotionBubble.prototype.charge=function(d){return-Math.pow(d.r,2)/8},MotionBubble.prototype.start=function(){this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.diameter])},MotionBubble.prototype.tickNodes=function(e,moveCallback){this.circles.each(moveCallback(e.alpha)).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y})},MotionBubble.prototype.groupAll=function(nodes,filter){var thiz=this;currentTime=(new Date).getTime(),thiz.currentFilterTime=currentTime,thiz.hideFilters(),this.force.gravity(this.layoutGravity).charge(this.charge).friction(.9).on("tick",function(e){thiz.tickNodes(e,function(alpha){return"undefined"!=typeof filter?thiz.moveTowardsFilter(alpha,filter):thiz.moveTowardsCenter(alpha)})}),"undefined"!=typeof filter&&(this.resizeViz(this.filtersData[filter].MAX_Y),setTimeout(function(curtime){thiz.currentFilterTime===curtime&&thiz.displayFilters(filter)},.75*this.config.bubble.animation,currentTime)),this.force.start()},MotionBubble.prototype.moveTowardsCenter=function(alpha){var thiz=this;return function(d){return d.x=d.x+(thiz.center.x-d.x)*thiz.damper*alpha,d.y=d.y+(thiz.center.y-d.y)*thiz.damper*alpha}},MotionBubble.prototype.moveTowardsFilter=function(alpha,filter){var thiz=this,xpadding=80;return function(d){var target=thiz.filterCenters[filter][d[filter]];d3.select(this).attr("data-filter",d[filter]),d.x=d.x+(target.x-d.x)*thiz.damper*alpha,d.x=d.x<=0?2*d.r:d.x,d.x=d.x+d.r>thiz.width+xpadding?d.x-d.r:d.x,d.y=d.y+(target.y-d.y)*thiz.damper*alpha}},MotionBubble.prototype.getLabelXY=function(filter){var xy={x:0,y:0};return $("#"+this.vizId).find("[data-filter= '"+filter+"']").each(function(e){var cx=parseFloat($(this).attr("cx")),cy=parseFloat($(this).attr("cy")),r=parseFloat($(this).attr("r"));xy.x=0==xy.x||cx-r<xy.x?cx-r:xy.x,xy.y=0==xy.y||cy+2*r>xy.y?cy+2*r:xy.y}),xy},MotionBubble.prototype.text=function(node,center,filter){var thiz=this,g=node.append("g").attr("class","filters").filter(function(d){return"undefined"!=typeof center[d].r}).attr("transform",function(d){var dt=center[d],pts=thiz.getLabelXY(d);return pts.x+=dt.r,pts.y+=25,"translate("+pts.x+","+pts.y+")"}).attr("text-anchor","middle");g.append("text").attr("class","labels").text(function(d){return thiz.config.format.text(d)}),g.append("text").attr("class","size").text(function(d){var dt=center[d];return thiz.config.format.number(dt.size)}).attr("y",20);return g},MotionBubble.prototype.displayFilters=function(attr){var thiz=this,data=d3.keys(this.filterCenters[attr]),center=thiz.filterCenters[attr],filters=d3.select("#"+this.vizId).select("svg").selectAll(".filters").data(data).enter();return thiz.text(filters,center,attr)},MotionBubble.prototype.hideFilters=function(){d3.select("#"+this.vizId).selectAll(".filters").remove(),this.resizeViz(this.diameter)},MotionBubble.prototype.legend=function(){function circle(node,r){return node.append("circle").attr("r",r).attr("class","legend")}function text(node,size){var txt="_____ ";return txt+=thiz.config.format.number(size),node.append("text").attr("x",rmax-rmin).text(txt)}var thiz=this,rmin=thiz.rscale(this.sizeData.min),rmax=thiz.rscale(this.sizeData.max),container=d3.select("#"+this.legendId).style("margin-top",-(3*rmax+100)+"px").attr("class","legend-container hidden-sm hidden-xs"),overview=container.append("div").attr("class","legend-overview");this.config.legend.title&&overview.append("h3").text(this.config.legend.title),overview.append("p").text(this.config.legend.description);var svg=container.append("svg");if(this.config.legend.footer){var footer=container.append("div").attr("class","legend-footer");footer.append("p").text(this.config.legend.footer)}var node=svg.append("g").attr("transform","translate("+rmax+", "+rmax+")");text(node,this.sizeData.max).attr("y",-(rmax-10)),circle(node,rmax).attr("cy",10),text(node,this.sizeData.min).attr("y",rmax-10),circle(node,rmin).attr("cy",rmax)},MotionBubble.prototype.legendRight=function(){function circle(node,r){return node.append("circle").attr("r",r).attr("class","legend")}function texto(node,txt){return node.append("text").attr("x",rmax-rmin).text(txt)}var thiz=this,rmin=thiz.rscale(this.sizeData.min),rmax=thiz.rscale(this.sizeData.max),container=d3.select("#"+this.legendRightId).style("margin-top",3*rmin+"px").style("position","absolute").style("right","0px").style("width","250px").attr("class","legend-container hidden-sm hidden-xs"),svg=container.append("svg");svg.style("height","500px");var node=svg.append("g").attr("transform","translate("+rmin+", "+rmin+")"),rref=rmin/2,k=1;for(var key in this.filters[this.config.label])circle(node,rref).attr("cy",4*k*rref).attr("cx",0).attr("class","node").attr("fill",this.config.color(this.filters[this.config.label][key])),texto(node,this.filters[this.config.label][key]).attr("y",4*k*rref+rref/2).attr("x",2*rref),k++};;
function BubbleChart(options){this.config=new ConfigBuilder;for(var attr in options)"format"==attr&&(options.format=d3plus.object.merge(this.config.format,options.format)),this.config[attr]=options[attr];"tree"==this.config.type?this.builder=new TreeBuilder(this.config):"orbit"==this.config.type?this.builder=new OrbitBuilder(this.config):"list"==this.config.type?this.builder=new ListBuilder(this.config):"motion"==this.config.type?this.builder=new MotionBubble(this.config):this.builder=new BubbleBuilder(this.config)}BubbleChart.prototype.data=function(data){this.builder.data(data)},BubbleChart.prototype.on=function(event,handler){this.builder.event[event]=handler};